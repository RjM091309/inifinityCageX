<%- include('../partials/header') %>
	<%- include('../partials/loader') %>
		<%- include ('../partials/sidebar'); -%>
			<%- include ('../partials/topbar'); -%>


				<!-- Main Container -->
				<div class="container-fluid content-inner mt-4">
					<div class="row">
						<div class="col-sm-12">
							<div class="card">
								<div id="user-role" data-permissions="<%= permissions %>"></div>
								<div class="card-header d-flex flex-wrap justify-content-between align-items-center">
									<div class="mb-2 mb-md-0">
									  <div class="breadcrumb1 flat">
										<a href="/dashboard"><span class="fa fa-home"></span></a>
										<a href="/game_list" class="active"><%= __('gamelist.game_book') %></a>
										<a href="#"  onclick="addGameList()"><span class="fa fa-plus me-2"></span><%= __('gamelist.new_game') %></a>
									  </div>								 
									</div>								  
									<!-- DATE FILTER -->																
								</div>

								<div class="dataTables_wrapper">
									<div class="row mb-2">
										<div class="col-sm-4">
											<input type="text" id="daterange" class="input-daterange input-group" placeholder="Select Date Range" autocomplete="off"/>
										</div>
									</div>
								</div>

								<div class="card-body">
							
									<table id="game_list-tbl" class="table  nowrap small-text" style="width:100%">

										<thead>
											<tr>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.game_start') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.type') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.game#') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.acct_no') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.initial_buyin') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.addt_l_buyin') %>
												</th>
												<th class="d-none d-sm-table-cell text-center col-total-amt">
													<%= __('gamelist.total_amt') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.real_rolling') %>
												</th>
												<th class="d-none d-sm-table-cell text-center col-total-rolling" >
													<%= __('gamelist.total_rolling') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.chips_return') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.game_rate') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.commission') %>
												</th>
												<th class="d-none d-sm-table-cell text-center col-winloss" >
													<%= __('gamelist.win_loss') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.game_source') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.game_end') %>
												</th>
												<th class="d-none d-sm-table-cell text-center">
													<%= __('gamelist.action') %>
												</th>
											</tr>
										</thead>
										<tbody class="text-center">
											<!-- Data will be populated here -->
										</tbody>
										<tfoot>
											<tr>
												<th colspan="4">
													<%= __('gamelist.grand_total') %>
												</th>
												<th></th>
												<th></th>
												<th class="d-none d-sm-table-cell text-center col-total-amt" id="GRAND_TOTAL_AMOUNT">₱0.00</th>
												<th></th>
												<th class="d-none d-sm-table-cell text-center col-total-rolling" id="GRAND_TOTAL_ROLLING">
													₱0.00</th>
												<th class="d-none d-sm-table-cell text-center" id="GRAND_CHIPS_RETURN">
													₱0.00</th>
												<th></th>
												<th></th>
												<th class="d-none d-sm-table-cell text-center col-winloss" id="GRAND_WIN_LOSS">₱0.00
												</th>
												<th></th>
												<th></th>
												<th></th>
											</tr>
										</tfoot>
									</table>

								</div>
							</div>
						</div>
					</div>
				</div>

				<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>




				<%- include ('../partials/footer'); -%>


					<style>

.card-body {
  overflow-x: auto;
  background-color: #ffffff;
}

/* Header + Footer Colors */
td.col-total-amt,
th.col-total-amt {
    background-color: #e8f5e9 !important; /* Lighter green */
    color: #2e7d32 !important; /* Darker green text */
    font-weight: 600;
}

td.col-total-rolling,
th.col-total-rolling {
    background-color: #e3f2fd !important; /* Lighter blue */
    color: #1565c0 !important; /* Darker blue text */
    font-weight: 600;
}

td.col-winloss,
th.col-winloss {
    background-color: #fff3e0 !important; /* Lighter orange */
    color: #ef6c00 !important; /* Darker orange text */
    font-weight: 600;
}

/* Base table styles */
#game_list-tbl {
    width: 100%;
    font-size: 11px;
    border-collapse: separate;
    border-spacing: 0;
    background-color: #ffffff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Header styles */
#game_list-tbl thead th {
    background: #f4f6fa;
    color: #495057;
    font-weight: 600;
    padding: 12px 15px;
    text-align: center;
    border: none;
    border-bottom: 2px solid #dee2e6;
}

/* Row styles */
#game_list-tbl tbody tr {
    border-bottom: 1px solid #e9ecef;
    transition: background-color 0.2s ease;
}

#game_list-tbl tbody tr:hover {
    background-color: #f8f9fa !important;
}

/* Cell styles */
#game_list-tbl td {
    padding: 12px 15px;
    color: #495057;
}

/* Footer total row */
#game_list-tbl tfoot th {
    padding: 12px;
    font-weight: 600;
    color: #495057;
    background-color: #f4f6fa;
    border-top: 2px solid #dee2e6;
}

/* Highlight row animation */
@keyframes highlightRow {
    0% { background-color: #f0f7ff; }
    50% { background-color: #e3f2fd; }
    100% { background-color: #f0f7ff; }
}

table.dataTable tbody tr.highlight-row {
    background-color: #f0f7ff !important;
    position: relative;
}



/* Select2 styling */
.select2-container--default .select2-selection--single {
    border-color: #dee2e6;
    border-radius: 4px;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #495057;
}

.select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: #6c757d;
}

						@keyframes highlightRow {
							0% {
								background-color: #f0f2ff;
							}

							50% {
								background-color: #e6e9ff;
							}

							100% {
								background-color: #f0f2ff;
							}
						}

						table.dataTable tbody tr.highlight-row {
							background-color: #f0f2ff !important;
							position: relative;
						}

						/* Header + Footer */
						td.col-total-amt {
	background-color: #e3f2e1 !important;
	
}

td.col-total-rolling {
	background-color: #e4f0fb !important;

}

td.col-winloss {
	background-color: #fff0e1 !important;
	
}
td.col-total-amt,
th.col-total-amt {
	background-color: #e3f2e1 !important; /* green */
	
}

td.col-total-rolling,
th.col-total-rolling {
	background-color: #e4f0fb !important; /* blue */
	
}

td.col-winloss,
th.col-winloss {
	background-color: #fff0e1 !important; /* orange */
	
}




						/* Adjust cell padding to account for left border */
						table.dataTable tbody tr.highlight-row td {
							background-color: transparent !important;
							font-weight: 600;
							color: #333;
						}

						/* Keep consistent with your existing table hover */
						table.dataTable tbody tr.highlight-row:hover {
							background-color: #e6e9ff !important;
						}

						/* Ensure proper spacing */
						table.dataTable {
							border-collapse: separate;
							border-spacing: 0;
						}

						/* Maintain your existing table borders */
						table.dataTable tbody tr {
							border-bottom: 1px solid #eee;
						}

						/* Ensure proper cell alignment */
						table.dataTable tbody tr td {
							vertical-align: middle;
							padding: 12px 15px;
						}

						@media screen and (max-width: 768px) {
	.dataTables_wrapper .dataTables_length,
	.dataTables_wrapper .dataTables_filter {
		text-align: left;
	}

	#game_list-tbl thead {
		display: none;
	}
}

				


						.table th,
						.table td {
							text-align: center;
							vertical-align: middle;
						}

						/* Square icon buttons in Action column */
						.action-btn-square {
							width: 26px;
							height: 26px;
							padding: 0 !important;
							display: inline-flex;
							align-items: center;
							justify-content: center;
							border-radius: 6px;
						}

						.grand-total {
							font-weight: bold;
							font-size: 18px;
						}

						.table-controls {
							display: flex;
							justify-content: space-between;
							margin-bottom: 10px;
						}

						.table-controls select,
						.table-controls input {
							padding: 5px;
							border: 1px solid #ccc;
							border-radius: 5px;
						}

						/* Adjust spacing and alignment for date range picker */
						.dataTables_wrapper .row {
							margin-bottom: 15px;
							/* Adjust spacing as needed */
						}

						/* Flexbox layout for the date range picker */
						.input-daterange {
							display: flex;
							justify-content: space-between;
							position: relative;

							top: 2.9rem;
							max-width: 300px;
							/* Limit the width */
						}

						/* Styling for form controls */
						.input-daterange .form-control {
							flex: 1;
							max-width: 120px;
							/* Limit the input width */
						}

						/* Remove margin from the last input */
						.input-daterange .form-control:last-child {
							margin-right: 0;
						}


						.nav-tabs-custom .nav-link {
							padding: 0.5rem 1rem;
							font-size: 0.875rem;
						}

						.nav-tabs-custom .nav-link .mdi {
							font-size: 1.25rem;
						}

						.nav-tabs-custom .nav-item {
							margin-bottom: 0;
						}

						.small-text {
							font-size: 0.70rem;
							/* Mas maliit na font size */
						}

						.small-text th,
						.small-text td {
							padding: 0.5rem !important;
							/* Mas maliit na padding */
						}

						.select2-container .select2-selection--single {
							height: calc(1.5em + 0.75rem + 2px);
						}

						.select2-container .select2-search--inline .select2-search__field {
							margin-top: 0;
							margin: 0.25rem 0.25rem 0.25rem 0;
							height: 1.375rem;
							line-height: 1.375rem;
						}

						.select2-container--default .select2-selection--single {
							border-color: #eee;

						}

						.select2-container--default .select2-selection--single .select2-selection__rendered {
							display: flex;
							align-items: center;
							padding-left: 0.75rem;
							height: calc(1.5em + 0.75rem + 2px);
							line-height: 1.5;
						}

						.select2-container--default .select2-selection--single .select2-selection__arrow {
							height: calc(1.5em + 0.75rem + 2px);
						}

						.select2-container--default .select2-selection--single .select2-selection__placeholder {
							color: #8A92A6;
						}

						.select2-container--default .select2-selection--multiple .select2-selection__rendered {
							padding-right: 0.75rem;
							padding-left: 0.75rem;
						}

						/* Itago ang text na "Show" at "entries" sa DataTables */
						.dataTables_length label {
							font-size: 0;
							/* Itatago ang text */
						}

						/* Panatilihin ang dropdown na nakikita */
						.dataTables_length select {
							font-size: 12px;
							/* Ibalik ang font size ng dropdown */
						}



						/* Adjust spacing and alignment for date range picker */
						.dataTables_wrapper .row {
							margin-bottom: 15px;
							font-size: 12px;
							/* Pareho sa commission-tbl */
						}

						/* Flexbox layout for the date range picker */
						.input-daterange {
							display: flex;
							justify-content: space-between;
							position: relative;
							left: 7.5rem;
							top: 4rem;
							max-width: 300px;
							font-size: 12px;
							/* Pareho sa commission-tbl */
						}

						/* Styling for form controls */
						.input-daterange .form-control {
							flex: 1;
							margin-right: 5px;
							max-width: 120px;
							font-size: 12px;
							/* Pareho sa commission-tbl */
							padding: 8px;
							/* Pareho sa cell padding ng table */
						}

						/* Remove margin from the last input */
						.input-daterange .form-control:last-child {
							margin-right: 0;
						}

						/* Responsive tweaks */
						@media (max-width: 768px) {

							.dataTables_wrapper .row,
							.input-daterange,
							.input-daterange .form-control {
								font-size: 10px;
								/* Mas maliit sa mobile */
							}

							.input-daterange .form-control {
								padding: 5px;
								/* Mas maliit na padding */
							}
						}

						/* Make breadcrumbs + buttons layout clean on small screens */
					@media (max-width: 768px) {
						.card-header {
							flex-direction: column !important;
							align-items: flex-start !important;
						}

						.card-header .card-title,
						.card-header button {
							width: 100%;
							text-align: left;
						}
					}

					</style>


					<script>
						$(document).ready(function () {
							function initializeDataTable() {
								if ($.fn.DataTable.isDataTable('#game_list-tbl')) {
									$('#game_list-tbl').DataTable().destroy();
								}

								$('#game_list-tbl').DataTable({
									"ajax": {
										"url": "/game_list_data",
										"dataSrc": function (json) {
											console.log("Data received from server:", json);
											return json.data || []; // Default to empty array if no data
										}
									},
									"columns": [
										{ "data": "game_start_date" },
										{ "data": "game_type" },
										{ "data": "game_no" },
										{ "data": "acct_no" },
										{ "data": "initial_buy_in" },
										{ "data": "additional_buy_in" },
										{ "data": "total_amt" },
										{ "data": "real_rolling" },
										{ "data": "total_rolling" },
										{ "data": "chips_return" },
										{ "data": "game_rate" },
										{ "data": "commission" },
										{ "data": "win_loss" },
										{ "data": "game_type1" },
										{ "data": "game_end_date_time" },
										{ "data": "history" }
									],
									"drawCallback": function () {
										calculateTotal();
									}
								});
							}


							initializeDataTable();

							// Set default "From" date to the 1st day of the current month
							var currentDate = new Date();
							var firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
							var today = new Date();

							// Function to format the date as "dd mmm yyyy" (e.g., 01 Sept 2024)
							var formatDate = function (date) {
								var day = ("0" + date.getDate()).slice(-2); // Add leading zero for day
								var monthNames = ["Jan,", "Feb,", "Mar,", "Apr,", "May,", "Jun,", "Jul,", "Aug,", "Sep,", "Oct,", "Nov,", "Dec,"];
								var month = monthNames[date.getMonth()]; // Get the month abbreviation
								var year = date.getFullYear(); // Get the full year
								return day + ' ' + month + ' ' + year; // Return the formatted date as "dd mmm yyyy"
							};

							// Set default values to date inputs
							$('#from-date').val(formatDate(firstDayOfMonth));
							$('#to-date').val(formatDate(today));

							// Custom filtering function which will filter data based on the "From" and "To" dates
							$.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
								// Get the values from the "From" and "To" date inputs
								var minDate = $('#from-date').val() ? new Date($('#from-date').val()) : null;
								var maxDate = $('#to-date').val() ? new Date($('#to-date').val()) : null;

								// Get the game start date from the table data (Column index for "GAME START")
								var gameStartDate = new Date(data[0]); // Assuming GAME START is the first column (index 0)

								// Get the game end date from the table data (Column index for "GAME END DATE & TIME")
								var gameEndDate = new Date(data[0]); // Assuming GAME END DATE & TIME is column 13

								// Strip the time portion of the date by setting time to midnight (for date-only comparison)
								if (minDate !== null) {
									minDate.setHours(0, 0, 0, 0); // Set minDate to midnight
								}
								if (maxDate !== null) {
									maxDate.setHours(23, 59, 59, 999); // Set maxDate to the end of the day
								}
								gameStartDate.setHours(0, 0, 0, 0); // Strip the time portion of the gameStartDate
								gameEndDate.setHours(0, 0, 0, 0); // Strip the time portion of the gameEndDate

								// Apply the date filtering logic for both GAME START and GAME END DATE
								if ((minDate === null && maxDate === null) || // No date filtering
									(minDate === null && (gameStartDate <= maxDate || gameEndDate <= maxDate)) || // Only max date is provided
									(minDate <= gameStartDate && maxDate === null) || // Only min date is provided
									(minDate <= gameStartDate && gameStartDate <= maxDate) || // Both dates are within range (GAME START)
									(minDate <= gameEndDate && gameEndDate <= maxDate)) { // Both dates are within range (GAME END)
									return true; // If within range or no date filter, include the row
								}
								return false; // Exclude the row if it doesn't match the filter
							});

							// Re-draw the DataTable whenever the date inputs change
							$('#from-date, #to-date').change(function () {
								$('#game_list-tbl').DataTable().draw();
							});

							// Trigger the initial draw to apply the default date filtering on page load
							$('#game_list-tbl').DataTable().draw();


							function calculateTotal() {
								var totalAmount = 0;
								var totalRolling = 0;
								var totalChipsReturn = 0;
								var totalWinLoss = 0;

								var table = $('#game_list-tbl').DataTable();

								// Process only the rows on the current page
								table.rows({ page: 'current' }).every(function () {
									var data = this.data();
									// console.log("Processing object:", data);

									// Adjust these indices based on your columns configuration
									var amountIndex = 6; // Assuming "TOTAL AMT" is at index 6
									var rollingIndex = 8; // Assuming "TOTAL ROLLING" is at index 8
									var chipsReturnIndex = 9; // Assuming "CHIPS RETURN" is at index 9
									var winLossIndex = 12; // Assuming "WIN/LOSS" is at index 12

									var amountValue = data[amountIndex] || '0';
									var rollingValue = data[rollingIndex] || '0';
									var chipsReturnValue = data[chipsReturnIndex] || '0';
									var winLossValue = data[winLossIndex] || '0';

									// Remove HTML tags and clean values
									var cleanedAmountValue = parseFloat(amountValue.replace(/[^0-9.-]/g, '')) || 0;
									var cleanedRollingValue = parseFloat(rollingValue.replace(/[^0-9.-]/g, '')) || 0;
									var cleanedChipsReturnValue = parseFloat(chipsReturnValue.replace(/<[^>]*>/g, '').replace(/[^0-9.-]/g, '')) || 0;
									var cleanedWinLossValue = parseFloat(winLossValue.replace(/[^0-9.-]/g, '')) || 0;

									totalAmount += cleanedAmountValue;
									totalRolling += cleanedRollingValue;
									totalChipsReturn += cleanedChipsReturnValue;
									totalWinLoss += cleanedWinLossValue;
								});

								// Format the totals
								var formattedAmount = totalAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
								var formattedRolling = totalRolling.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
								var formattedChipsReturn = totalChipsReturn.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
								var formattedWinLoss = totalWinLoss.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

								// Update the footer content for the current page's totals
								$('#game_list-tbl tfoot #GRAND_TOTAL_AMOUNT').text(formattedAmount);
								$('#game_list-tbl tfoot #GRAND_TOTAL_ROLLING').text(formattedRolling);
								$('#game_list-tbl tfoot #GRAND_CHIPS_RETURN').text(formattedChipsReturn);
								$('#game_list-tbl tfoot #GRAND_WIN_LOSS').text(formattedWinLoss);

								// Apply red font color if the total is negative
								applyNegativeStyle('#GRAND_TOTAL_AMOUNT', totalAmount);
								applyNegativeStyle('#GRAND_TOTAL_ROLLING', totalRolling);
								applyNegativeStyle('#GRAND_CHIPS_RETURN', totalChipsReturn);
								applyNegativeStyle('#GRAND_WIN_LOSS', totalWinLoss);
							}

							// Attach events to recalculate totals on search and draw
							$('#game_list-tbl').on('search.dt draw.dt', function () {
								// console.log("Search or draw event triggered");
								calculateTotal();
							});
						});
						function applyNegativeStyle(selector, value) {
							var element = $('#game_list-tbl tfoot ' + selector);
							if (value < 0) {
								element.css('color', 'red');
							} else {
								element.css('color', ''); // Reset to default color
							}
						}


						const permissions = parseInt($('#user-role').data('permissions'));

						if (permissions === 2) {
							$('.wrap .button').prop('disabled', true);
						} else {
							$('.wrap .button').prop('disabled', false);
						}
					</script>

					<%- include ('../modals/game_book/new_game_list') %>
						<%- include ('../modals/game_book/change_status') %>
							<%- include ('../modals/game_book/add_buyin') %>
								<%- include ('../modals/game_book/add_rolling') %>
									<%- include ('../modals/game_book/add_cashout') %>
										<%- include ('../modals/game_book/show_rollings') %>
											<%- include ('../modals/game_book/settlement') %>
												<%- include ('../modals/game_book/game_services') %>


												<script src="/assets/js/functions/game_list.js"></script>
												<script src="assets/js/plugins/select2/js/select2.full.min.js"></script>



												<script>
													$('.js-select2').select2({
														placeholder: 'Select an option',
														dropdownParent: '#modal-new-game-list',
													});

												</script>