<div class="modal fade" id="modal-services-new-record" tabindex="-1" aria-labelledby="modal-services-new-record-label" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary">
        <h5 class="modal-title text-white" id="modal-services-new-record-label">New Service Record</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="new-services-game-id" />
        <input type="hidden" id="new-services-agent-id" />

        <div class="row g-3">
			<div class="col-md-4">
				<div class="fw-semibold text-muted">Transaction Type</div>
				<select id="new-transaction-type" class="form-select">
				  <option value="" selected disabled>Select Transaction</option>
				  <option value="JUNKET">Junket Payment</option>
				  <option value="GUEST">Guest Payment</option>
				
				</select>
			  </div>
          <div class="col-md-4" id="new-services-account-wrapper" style="display:none">
            <div class="fw-semibold text-muted">Account</div>
            <select id="new-services-account" class="form-select" disabled>
              <option value="" selected disabled>Select account</option>
            </select>
          </div>
          <div class="col-md-4">
            <div class="fw-semibold text-muted">Service Type</div>
            <select id="new-services-type" class="form-select">
              <option value="" selected disabled>Select service</option>
              <option value="fnb">F &amp; B</option>
              <option value="hotel">Hotel</option>
              <option value="delivery">Delivery</option>
            </select>
          </div>
          <div class="col-md-4">
            <div class="fw-semibold text-muted">Amount</div>
            <input type="text" id="new-services-amount" class="form-control" data-type="number" placeholder="Enter amount" />
            <div id="deposit-balance" class="text-muted small mt-1" style="display:none">
              Available balance: <span id="deposit-balance-value">0</span>
            </div>
          </div>
        </div>

        <div class="mt-3 mb-1 fw-semibold text-muted">Remarks</div>
        <textarea id="new-services-remarks" class="form-control" rows="2" placeholder="Optional remarks"></textarea>

        <div class="row mt-3 gx-4 justify-content-center" id="new-services-payment-methods">
          <div class="col-sm-3">
            <div class="form-check">
              <input class="form-check-input" style="border-color: #8a92a6 !important;" type="radio" value="1" id="new-services-transaction-cash" name="new-services-transaction" />
              <label class="form-check-label" for="new-services-transaction-cash">Cash</label>
            </div>
          </div>
          <div class="col-sm-3">
            <div class="form-check">
              <input class="form-check-input" style="border-color: #8a92a6 !important;" type="radio" value="2" id="new-services-transaction-deposit" name="new-services-transaction" />
              <label class="form-check-label" for="new-services-transaction-deposit">Deposit</label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="new-services-save" class="btn btn-sm btn-primary">Save</button>
        <button type="button" class="btn btn-sm btn-alt-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
	(function () {
		const $modal = $('#modal-services-new-record');
		const $accountSelect = $('#new-services-account');
		const $accountWrapper = $('#new-services-account-wrapper');
		const $transactionType = $('#new-transaction-type');
		const $paymentMethods = $('#new-services-payment-methods');
		const $agentInput = $('#new-services-agent-id');
		const $gameInput = $('#new-services-game-id');
		const $saveBtn = $('#new-services-save');
		const $balanceHint = $('#deposit-balance');
		const $balanceValue = $('#deposit-balance-value');
		let depositBalance = 0;

		function resetForm() {
			$transactionType.val('');
			$accountSelect.val('');
			$agentInput.val('');
			$gameInput.val('');
			$('#new-services-type').val('');
			$('#new-services-amount').val('');
			$('#new-services-remarks').val('');
			$('input[name="new-services-transaction"]').prop('checked', false);
			$paymentMethods.show();
		}

		function toggleAccountByTransactionType() {
			const type = $transactionType.val();
			const shouldShow = type === 'GUEST';
			if (shouldShow) {
				$accountWrapper.show();
				$accountSelect.prop('disabled', false);
				$paymentMethods.show();
			} else {
				$accountWrapper.hide();
				$accountSelect.val('').prop('disabled', true);
				$agentInput.val('');
				$gameInput.val('');
				depositBalance = 0;
				updateBalanceHint();
				$paymentMethods.hide();
				$('#new-services-transaction-cash').prop('checked', true);
			}
		}

		async function populateAccounts() {
			$accountSelect.prop('disabled', true);
			try {
				const res = await fetch('/fnb-hotel/accounts');
				if (!res.ok) {
					throw new Error('Unable to load accounts.');
				}
				const accounts = await res.json();
				$accountSelect.empty();
				$accountSelect.append('<option value="" selected disabled>Select account</option>');
				accounts.forEach(acc => {
					const label = acc.agent_name
						? `${acc.agent_name} (${acc.agent_code || 'No code'})`
						: `Account #${acc.account_id}`;
					const $option = $('<option>')
						.val(acc.account_id)
						.text(label)
						.data('agentId', acc.agent_id)
						.data('gameId', acc.current_game_id || '')
						.data('balance', acc.balance || 0);
					$accountSelect.append($option);
				});
			} catch (err) {
				console.error(err);
				$accountSelect.empty().append('<option value="" disabled>Failed to load accounts</option>');
			} finally {
				$accountSelect.prop('disabled', false);
			}
		}

		$modal.on('show.bs.modal', function () {
			resetForm();
			populateAccounts();
			toggleAccountByTransactionType();
		});

		function updateBalanceHint() {
			const transaction = $('input[name="new-services-transaction"]:checked').val();
			if (transaction === '2' && depositBalance !== null) {
				$balanceValue.text(depositBalance.toLocaleString('en-US'));
				$balanceHint.show();
			} else {
				$balanceHint.hide();
			}
		}

		async function loadDepositBalance(accountId) {
			depositBalance = 0;
			if (!accountId) return;

			try {
				const response = await fetch(`/account_details_data_deposit/${accountId}`);
				if (!response.ok) throw new Error('Failed to fetch deposit data');
				const data = await response.json();

				let deposit_amount = 0;
				let withdraw_amount = 0;
				let marker_issue_amount = 0;
				let marker_return = 0;

				data.forEach(row => {
					const amount = parseFloat(row.AMOUNT || 0);
					if (row.TRANSACTION === 'DEPOSIT') {
						deposit_amount += amount;
					} else if (row.TRANSACTION === 'WITHDRAW') {
						withdraw_amount += amount;
					} else if (row.TRANSACTION === 'Credit Cash') {
						marker_issue_amount += amount;
					} else if (row.TRANSACTION === 'Credit Returned thru Deposit') {
						marker_return += amount;
					}
				});

				depositBalance = deposit_amount + marker_issue_amount - withdraw_amount - marker_return;
			} catch (err) {
				console.error('Error loading deposit balance', err);
				depositBalance = 0;
			}
		}

		$accountSelect.on('change', async function () {
			const $selected = $(this).find('option:selected');
			$agentInput.val($selected.data('agentId') || '');
			$gameInput.val($selected.data('gameId') || '');
			await loadDepositBalance($selected.val());
			updateBalanceHint();
		});

		$('input[name="new-services-transaction"]').on('change', updateBalanceHint);
		$transactionType.on('change', toggleAccountByTransactionType);

		$('#new-services-amount').on('input', function (event) {
			// allow digits and single decimal point, format with commas
			const $input = $(this);
			let raw = $input.val() || '';
			raw = raw.replace(/[^\d.]/g, '');
			const parts = raw.split('.');
			if (parts.length > 2) {
				raw = `${parts[0]}.${parts.slice(1).join('')}`;
			}
			const [intPart, decPart] = raw.split('.');
			const formattedInt = (intPart || '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
			const formatted = decPart !== undefined ? `${formattedInt}.${decPart}` : formattedInt;
			$input.val(formatted);
		});

		$saveBtn.on('click', async function () {
			const accountId = $accountSelect.val();
			const agentId = $agentInput.val();
			const gameId = $gameInput.val();
			const serviceType = $('#new-services-type').val();
			const amountRaw = $('#new-services-amount').val().replace(/,/g, '').trim();
			const amount = parseFloat(amountRaw) || 0;
			const remarks = $('#new-services-remarks').val().trim();
			const transactionId = $('input[name="new-services-transaction"]:checked').val();
			const sourceType = $transactionType.val();

			if (!sourceType) {
				Swal.fire({ icon: 'warning', title: 'Missing fields', text: 'Select who is paying.' });
				return;
			}
			if (!serviceType) {
				Swal.fire({ icon: 'warning', title: 'Missing fields', text: 'Select a service type.' });
				return;
			}
			if (sourceType === 'GUEST' && !accountId) {
				Swal.fire({ icon: 'warning', title: 'Missing fields', text: 'Select an account for guest payment.' });
				return;
			}
			if (!transactionId) {
				Swal.fire({ icon: 'warning', title: 'Missing fields', text: 'Select a transaction type.' });
				return;
			}

			$saveBtn.prop('disabled', true).text('Saving...');

			try {
				const response = await fetch('/fnb-hotel/service', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						account_id: accountId,
						agent_id: agentId,
						game_id: gameId,
						service_type: serviceType,
						amount,
						remarks,
						transaction_id: transactionId,
						source_type: sourceType
					})
				});

				if (!response.ok) {
					const error = await response.json().catch(() => ({}));
					throw new Error(error.error || 'Failed to create service record.');
				}

				await Swal.fire({
					icon: 'success',
					title: 'Service recorded',
					timer: 1200,
					showConfirmButton: false
				});

				window.location.reload();
			} catch (err) {
				Swal.fire({ icon: 'error', title: 'Error', text: err.message || 'Failed to save record.' });
			} finally {
				$saveBtn.prop('disabled', false).text('Save');
			}
		});
	})();
</script>

