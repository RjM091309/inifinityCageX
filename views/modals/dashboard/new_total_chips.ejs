<!-- Modal -->
<div class="modal fade" id="modal-new-total-chips" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLiveLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary">
        <h5 class="modal-title text-white" id="staticBackdropLiveLabel"><%= __('dashboard_total_chips.total_chips') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="add_junket_total_chips" action="/add_junket_total_chips" method="POST">

          <!-- NN Chips -->
          <div class="row mb-2">
            <div class="col-sm-12">
              <input 
                type="text"
                class="form-control"
                placeholder="<%= __('dashboard_total_chips.nn_chips') %>"
                id="nnChips"
                name="txtNNChips"
                onkeypress="return onlyNumberKey(event)"
                data-type="number"
                autocomplete="off" 
              />
            </div>
          </div>

          <!-- CC Chips -->
          <div class="row mb-2">
            <div class="col-sm-12">
              <input
                type="text"
                class="form-control"
                placeholder="<%= __('dashboard_total_chips.cc_chips') %>"
                id="ccChips"
                name="txtCCChips"
                onkeypress="return onlyNumberKey(event)"
                data-type="number"
                autocomplete="off"
              />
            </div>
          </div>

          <!-- Total Chips (read-only) -->
          <div class="row mb-2">
            <div class="col-sm-12">
              <input 
                type="text"
                placeholder="<%= __('dashboard_total_chips.total_chips') %>"
                class="form-control"
                id="totalChips"
                name="txtTotalChips"
                disabled
              />
            </div>
          </div>

          <!-- Hidden fields for balances -->
          <input type="hidden" value="<%-  parseFloat(sqlCCChipsBuyin[0].CCChipsBuyin - sqlCCChipsReturn[0].CCChipsReturn + sqlTotalRealRolling[0].TOTAL_REAL_ROLLING + sqlAccountCCChipsReturn[0].CC_CHIPS_RETURN - sqlCCChipsBuyinGame[0].TOTAL_CC + sqlCCBuyin[0].CCBuyin - sqlCCReturn[0].CCReturn).toLocaleString()  %>
                                " id="ccbalance" name="txtccbalance" />

                        <input type="hidden" value="<%-  parseFloat(sqlNNChipsBuyin[0].NNChipsBuyin - sqlNNChipsReturn[0].NNChipsReturn - sqlAccountNNChips[0].TOTAL_NN + sqlTotalCashOutRolling[0].TOTAL_CASHOUT - sqlTotalRealRolling[0].TOTAL_REAL_ROLLING - sqlCCChipsBuyin[0].CCChipsBuyin + sqlCCChipsReturn[0].CCChipsReturn + sqlNNBuyin[0].NNBuyin - sqlNNReturn[0].NNReturn).toLocaleString()  %>
                                " id="nnbalance" name="txtnnbalance" />

                        <input type="hidden" value="  <%-  parseFloat(sqlCashDeposit[0].CASH_DEPOSIT  - sqlCashWithdraw[0].CASH_WITHDRAW - sqlNNChipsBuyin[0].NNChipsBuyin + sqlNNChipsReturn[0].NNChipsReturn + sqlNNChipsAccountMarker[0].TOTAL_NN_MARKER - sqlAccountSettlement[0].ACCOUNT_SETTLEMENT + sqlMArkerReturnCash[0].MARKER_RETURN_CASH -sqlAccountWithdraw[0].ACCOUNT_WITHDRAW + sqlAccountMarkerReturn[0].MARKER_RETURN - sqlJunketExpense[0].JUNKET_EXPENSE ).toLocaleString()  %>
                                " id="cashbal" name="txtcashbal" />

                        <!-- Match House Balance computation from dashboard.ejs -->
                        <input type="hidden" value="<%- ( (+sqlCashDeposit[0].CASH_DEPOSIT || 0) +
                                             (+sqlMArkerReturnDeposit[0].MARKER_RETURN_DEPOSIT || 0) -
                                             (+sqlCashWithdraw[0].CASH_WITHDRAW || 0) - (+sqlNNChipsBuyin[0].NNChipsBuyin || 0) +
                                             (+sqlNNChipsReturn[0].NNChipsReturn || 0) +
                                             (+sqlNNChipsAccountMarker[0].TOTAL_NN_MARKER || 0) -
                                             (+sqlAccountSettlement[0].ACCOUNT_SETTLEMENT || 0) +
                                             (+sqlMArkerReturnCash[0].MARKER_RETURN_CASH || 0) -
                                             (+sqlAccountDeduct[0].ACCOUNT_DEDUCT || 0) +
                                             (+sqlAccountMarkerReturn[0].MARKER_RETURN || 0) -
                                             (+sqlJunketExpense[0].JUNKET_EXPENSE || 0) +
                                             (+sqlNNChipsBuyinCashDeposit[0].NN_CHIPS_BUYIN_CASH_DEPOSIT || 0) +
                                             (+sqlCCChipsBuyinCashDeposit[0].CC_CHIPS_BUYIN_CASH_DEPOSIT || 0) -
                                             (+sqlMarkerIssueAccount[0].TOTAL_ISSUE_RECORD || 0) -
                                             (+sqlTotalCashOut[0].TOTAL_CASHOUT || 0) +
                                             (+sqlNNChipsAccountDeposit[0].TOTAL_NN_DEPOSIT || 0) +
                                             (+sqlAccountTransfer[0].ACCOUNT_TRANSFER || 0) ).toLocaleString() %>"
                                id="housebal" name="txthousebal" />

                        <input type="hidden" name="typedescription" id="typedescription" value="Chips Buy-in">

          <!-- Radio Buttons -->
          <div class="row mb-2 align-items-center d-flex justify-content-center">
            <div class="col-sm-6 d-flex justify-content-center">
              <div class="form-check">
                <input 
                  class="form-check-input" style="border-color: #8a92a6 !important;"
                  type="radio"
                  id="add"
                  name="optBuyinReturn"
                  value="1"
                  onclick="updatetypeDescription()"
                  required
                >
                <label class="form-check-label" for="add"><%= __('dashboard_total_chips.chips_buyin') %></label>
              </div>
            </div>
            <div class="col-sm-6 d-flex justify-content-center">
              <div class="form-check">
                <input
                  class="form-check-input" style="border-color: #8a92a6 !important;"
                  type="radio"
                  id="deduct"
                  name="optBuyinReturn"
                  value="2"
                  onclick="updatetypeDescription()"
                  required
                >
                <label class="form-check-label" for="deduct"><%= __('dashboard_total_chips.chips_return') %></label>
              </div>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <!-- NOTE: Removed onclick from here -->
            <button type="submit" class="btn btn-sm btn-primary"><i class="fa fa-check-circle me-1"></i>
              <%= __('dashboard_total_chips.save') %>
            </button>
            <button
              type="button"
              class="btn btn-sm btn-alt-secondary"
              data-bs-dismiss="modal"
            >
              <%= __('dashboard_total_chips.close') %>
            </button>
          </div>

        </form>

        <hr style="border: none; border-top: 0.2rem solid black; margin-top: 20px; margin-bottom: 20px;">
        
        <!-- History Section -->
        <div class="row mb-3">
          <div class="col-sm-4">
            <input type="text" id="total-chips-daterange" name="total-chips-daterange" class="form-control"
                placeholder="Select date range" autocomplete="off" />
          </div>
        </div>

        <table id="total-chips-history-tbl" class="table table-bordered table-responsive"
            style="font-size: 13px !important;">
          <thead>
            <tr>
              <th>Encoded By</th>
              <th>Amount</th>
              <th>Type</th>
              <th>Remarks</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<style>
  .modal-lg {
    max-width: 90% !important;
  }

  #total-chips-history-tbl {
    width: 100%;
    font-size: 13px;
    border-collapse: collapse;
  }

  /* Header styles */
  #total-chips-history-tbl thead th {
    background: var(--bs-primary-bg-subtle);
    color: var(--bs-primary);
    font-weight: 500;
    padding: 12px 15px;
    text-align: left;
    border: none;
  }

  /* Row styles */
  #total-chips-history-tbl tbody tr {
    border-bottom: 1px solid #eee;
  }

  /* Cell styles */
  #total-chips-history-tbl td {
    padding: 12px 15px;
    color: #666;
  }

  #total-chips-history-tbl tbody tr:hover {
    background-color: #f5f5f5 !important;
  }

  /* Balance column */
  #total-chips-history-tbl td:last-child {
    text-align: right;
    color: #333;
  }

  /* Footer total row */
  #total-chips-history-tbl tfoot th {
    padding: 10px;
    font-weight: 600;
    color: #333;
    background-color: #f4f6fa;
    border-top: 2px solid #dee2e6;
  }
</style>

<script>
$(document).ready(function() {
  // 1) Permissions
  const permissions = parseInt($('#user-role').data('permissions')) || 0;
  if (permissions === 2) {
    $('#add_junket_total_chips button[type="submit"]').prop('disabled', true);
  }

  // 2) Update typedescription on radio change
  window.updatetypeDescription = function() {
    const isBuyin = document.getElementById('add').checked;
    document.getElementById('typedescription').value = isBuyin
      ? '<span class="css-red">Chips Buy-in</span>'
      : '<span class="css-red">Chips Return</span>';
  }

  // 3) Only number key
  window.onlyNumberKey = function(evt) {
    let charCode = (evt.which) ? evt.which : evt.keyCode;
    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
      return false;
    }
    return true;
  }

  // 4) Format numbers with commas
  window.formatNumberWithCommas = function(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  // 5) validateChips function
  //    - Pag Buy-in ng NN Chips: hindi pwede mas mataas sa House Balance
  //    - Pag Buy-in ng CC Chips: hindi pwede mas mataas sa NN balance
  //    - Pag Return: hindi pwede lumampas o kapag 0 / negative na ang balance
  window.validateChips = function() {
    const selected = $('input[name="optBuyinReturn"]:checked').val(); // "1" buy-in, "2" return

    const nnChips   = parseFloat(($('#nnChips').val()    || '0').toString().replace(/,/g, '')) || 0;
    const ccChips   = parseFloat(($('#ccChips').val()    || '0').toString().replace(/,/g, '')) || 0;
    const nnbalance = parseFloat(($('#nnbalance').val()  || '0').toString().replace(/,/g, '')) || 0;
    const ccbalance = parseFloat(($('#ccbalance').val()  || '0').toString().replace(/,/g, '')) || 0;
    const houseBal  = parseFloat(($('#housebal').val()   || '0').toString().replace(/,/g, '')) || 0;

    // BUY-IN
    if (selected === "1") {
      // NN Chips must not exceed House Balance
      if (nnChips > houseBal) {
        Swal.fire({
          icon: 'error',
          title: 'Insufficient House Balance',
          text: 'NN Chips Buy-in cannot exceed the current House Balance of ' + formatNumberWithCommas(houseBal) + '.'
        });
        return false;
      }

      // CC Chips must not exceed NN Balance
      if (ccChips > nnbalance) {
        Swal.fire({
          icon: 'error',
          title: 'Insufficient NN Balance',
          text: 'CC Chips Buy-in cannot exceed the current NN Balance of ' + formatNumberWithCommas(nnbalance) + '.'
        });
        return false;
      }
    }

    // RETURN
    if (selected === "2") {
      // Disallow CC return when CC balance is 0 or negative
      if (ccbalance <= 0 && ccChips > 0) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Transaction',
          text: 'CC Chips Return cannot proceed. Current CC balance is 0 or negative.'
        });
        return false;
      }

      // Disallow NN return when NN balance is 0 or negative
      if (nnbalance <= 0 && nnChips > 0) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Transaction',
          text: 'NN Chips Return cannot proceed. Current NN balance is 0 or negative.'
        });
        return false;
      }

      // NN Return cannot exceed NN balance
      if (nnChips > nnbalance) {
        Swal.fire({
          icon: 'warning',
          title: 'Exceeds NN Balance',
          text: 'NN Chips Return cannot exceed ' + formatNumberWithCommas(nnbalance) + '.'
        });
        return false;
      }

      // CC Return cannot exceed CC balance
      if (ccChips > ccbalance) {
        Swal.fire({
          icon: 'warning',
          title: 'Exceeds CC Balance',
          text: 'CC Chips Return cannot exceed ' + formatNumberWithCommas(ccbalance) + '.'
        });
        return false;
      }
    }

    return true;
  }

  // 6) Calculate total chips on input
  window.calculateTotalChips = function() {
    const nnChips = parseFloat($('#nnChips').val().replace(/,/g, '')) || 0;
    const ccChips = parseFloat($('#ccChips').val().replace(/,/g, '')) || 0;
    const totalChips = nnChips + ccChips;
    $('#totalChips').val(totalChips.toLocaleString());
  }

  $('#nnChips').on('input', calculateTotalChips);
  $('#ccChips').on('input', calculateTotalChips);

  // 7) Spinner logic on form submit
  $('#add_junket_total_chips').on('submit', function(e) {
    // If validation fails, stop (only if validateChips function exists)
    if (typeof validateChips === 'function' && !validateChips()) {
      e.preventDefault();
      return false;
    }

    // Show spinner
    const $btn = $(this).find("button[type='submit']");
    console.log("Submit button before update:", $btn);

    $btn.prop('disabled', true).html(`
      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      Loading...
    `);

    console.log("Spinner added, waiting 1 second before submitting form");

    // Delay so you can actually see the spinner
    e.preventDefault();
    setTimeout(() => {
      this.submit();
    }, 1000);
  });

  // 8) Combined NN and CC Chips History
  function loadTotalChipsHistory() {
    const dateRange = $('#total-chips-daterange').val();
    console.log('Total Chips History Date Range:', dateRange);

    if (!dateRange) {
      alert('Please select a date range.');
      return;
    }

    let startDate, endDate;
    if (dateRange.indexOf(" to ") > -1) {
      [startDate, endDate] = dateRange.split(" to ");
    } else {
      startDate = dateRange;
      endDate = dateRange;
    }
    console.log('Total Chips History Start Date:', startDate, 'End Date:', endDate);

    // Destroy existing DataTable instance if it exists
    if ($.fn.DataTable.isDataTable('#total-chips-history-tbl')) {
      $('#total-chips-history-tbl').DataTable().destroy();
    }

    // Fetch both NN and CC chips data
    Promise.all([
      // Fetch NN Chips data
      $.ajax({
        url: `/junket_capital_data?start_date=${startDate}&end_date=${endDate}&` + new Date().getTime(),
        type: "GET"
      }),
      // Fetch CC Chips data
      $.ajax({
        url: `/cc_chips_history?start_date=${startDate}&end_date=${endDate}&` + new Date().getTime(),
        type: "GET"
      })
    ]).then(function([nnData, ccData]) {
      console.log('Raw NN Chips Data:', nnData);
      console.log('Raw CC Chips Data:', ccData);

      // Process NN Chips data
      const nnFiltered = (Array.isArray(nnData) ? nnData : []).filter(row => {
        const chipsBuyIn = row.TRANSACTION_ID == 1 &&
          row.capital_description === '<span class="css-red">Chips Buy-in</span>';
        const chipsReturn = row.TRANSACTION_ID == 2 &&
          row.capital_description === '<span class="css-red">Chips Return</span>';
        const nnChips = parseFloat(row.NN_CHIPS) || 0;
        return (chipsBuyIn || chipsReturn) && nnChips > 0;
      }).map(function(row) {
        const isChipsBuyIn = row.TRANSACTION_ID == 1 &&
          row.capital_description === '<span class="css-red">Chips Buy-in</span>';
        const nnChips = parseFloat(row.NN_CHIPS) || 0;
        const amount = nnChips.toLocaleString();
        const type = isChipsBuyIn
          ? '<span class="css-red">NN Chips Buy-in</span>'
          : '<span class="css-blue">NN Chips Return</span>';

        return {
          encodedBy: row.ENCODED_BY_NAME || 'N/A',
          amount: amount,
          type: type,
          remarks: row.REMARKS ? row.REMARKS + (row.GAME_ID ? ` GAME-${row.GAME_ID}` : '') : '',
          date: moment.utc(row.ENCODED_DT).utcOffset(8).format('DD MMM, YYYY HH:mm:ss'),
          action: (typeof getActionButton === 'function' ? getActionButton(row.IDNo) : ''),
          sortDate: new Date(row.ENCODED_DT)
        };
      });

      // Process CC Chips data
      const ccFiltered = (Array.isArray(ccData) ? ccData : []).map(function(row) {
        const isChipsBuyIn = row.TRANSACTION_ID == 1;
        const ccChips = parseFloat(row.CC_CHIPS) || 0;
        const amount = ccChips.toLocaleString();
        const type = isChipsBuyIn
          ? '<span class="css-red">CC Chips Buy-in</span>'
          : '<span class="css-blue">CC Chips Return</span>';

        return {
          encodedBy: row.ENCODED_BY_NAME || 'N/A',
          amount: amount,
          type: type,
          remarks: '',
          date: moment.utc(row.ENCODED_DT).utcOffset(8).format('DD MMM, YYYY HH:mm:ss'),
          action: (typeof getActionButton === 'function' ? getActionButton(row.IDNo) : ''),
          sortDate: new Date(row.ENCODED_DT)
        };
      });

      // Combine and sort by date descending
      const combinedData = [...nnFiltered, ...ccFiltered].sort((a, b) => b.sortDate - a.sortDate);

      // Convert to DataTable format
      const tableData = combinedData.map(row => [
        row.encodedBy,
        row.amount,
        row.type,
        row.remarks,
        row.date,
        row.action
      ]);

      console.log('Combined Total Chips History Data:', tableData);

      // Initialize DataTable
      $('#total-chips-history-tbl').DataTable({
        processing: false,
        serverSide: false,
        data: tableData,
        order: [[4, 'desc']], // Sort by date descending
        columns: [
          { "className": "text-center" },
          { "className": "text-end" },
          { "className": "text-center" },
          { "className": "text-center" },
          { "className": "text-center" },
          { "className": "text-center", "orderable": false }
        ],
        responsive: true,
        language: {
          "emptyTable": "No chips transactions found",
          "processing": "Loading chips transactions..."
        },
        drawCallback: function(settings) {
          $('[data-bs-toggle="tooltip"]').tooltip();
        }
      });
    }).catch(function(error) {
      console.error('Error loading chips history:', error);
    });
  }

  // Initialize date picker and load history when modal is shown
  let totalChipsPicker = null;
  $('#modal-new-total-chips').on('shown.bs.modal', function () {
    console.log('Total Chips Modal shown');
    
    const startOfMonth = moment().startOf('month').format('YYYY-MM-DD');
    const currentDate = moment().format('YYYY-MM-DD');
    
    if ($('#total-chips-daterange').length > 0) {
      if (!totalChipsPicker || !$('#total-chips-daterange').hasClass('flatpickr-input')) {
        totalChipsPicker = flatpickr("#total-chips-daterange", {
          mode: "range",
          altInput: true,
          altFormat: "M d, Y",
          dateFormat: "Y-m-d",
          defaultDate: [startOfMonth, currentDate],
          showMonths: 2,
          onChange: function(selectedDates, dateStr) {
            console.log('Total Chips History Date changed:', dateStr);
            if (selectedDates.length === 2) {
              loadTotalChipsHistory();
            }
          }
        });
      }
      
      // Initial load of combined chips history data
      loadTotalChipsHistory();
    } else {
      console.error('total-chips-daterange element not found');
    }
  });
});
</script>
