<%- include('../partials/header') %>
<%- include ('../partials/sidebar'); -%>
<%- include ('../partials/topbar'); -%>

	<link rel="stylesheet" href="assets/js/plugins/select2/css/select2.min.css">
	<!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>


   <!-- Include jQuery -->
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!--DATEPICKER-->
  <link href="assets/libs/bootstrap-datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet">
  

			<div id="user-role" data-permissions="<%= permissions %>"></div>
			<div class="conatiner-fluid content-inner mt-n5 py-0">
				<div class="row">
					<div class="col-sm-12">
						<div class="card">
							<div class="card-header d-flex justify-content-between align-items-center">
								<h3 class="card-title">
									<div class="breadcrumb1 flat">
									<a href="/dashboard" ><span class="fa fa-home"></span></a>
									<a href="/agent_statistic" ><%= __('guest_game_statistic.statistics') %></a>
									<a href="/agent_statistic"class=""><%= __('guest_game_statistic.agent') %></a>
									<a href="/guest_statistic"class="" id="backToGuests"><%= __('guest_game_statistic.guests') %></a>
									<a href="/guest_game_statistic"class="active"><%= __('guest_game_statistic.game') %></a>
									</div>
								</h3>
							</div>
							<div class="block-content block-content-full">
							<div class="tab-content">
								<div class="tab-pane active p-3" id="home2" role="tabpanel">
									<div class="table-responsive">
										<table id="guest_game_statistic-tbl"class="table  nowrap small-text" style="width:100%">
											<thead>
												<tr>
												     <th class="d-none d-sm-table-cell text-center"><%= __('guest_game_statistic.game_number') %></th>
													<th class="d-none d-sm-table-cell text-center"><%= __('guest_game_statistic.buyin') %></th>
													<th class="d-none d-sm-table-cell text-center" ><%= __('guest_game_statistic.win_loss') %></th>
													<th class="d-none d-sm-table-cell text-center"><%= __('guest_game_statistic.rolling') %></th>
													<th class="d-none d-sm-table-cell text-center"><%= __('guest_game_statistic.commission') %></th>
													<th class="d-none d-sm-table-cell text-center"><%= __('guest_game_statistic.house_share') %></th>
													<th class="d-none d-sm-table-cell text-center"><%= __('guest_game_statistic.ngr') %></th>
													<th class="d-none d-sm-table-cell text-center"><%= __('guest_game_statistic.rtp') %></th>
													<th class="d-none d-sm-table-cell text-center"><%= __('guest_game_statistic.rm') %></th>
													<th class="d-none d-sm-table-cell text-center"><%= __('guest_game_statistic.expense') %></th>
													<th class="d-none d-sm-table-cell text-center"><%= __('guest_game_statistic.profit') %></th>
												</tr>
											</thead>
											<tbody class="text-center">
												<!-- Data will be populated here -->
											</tbody>
											<tfoot>
												<tr>
													
													<th><%= __('guest_game_statistic.grand_total') %></th>
													
													<th class="d-none d-sm-table-cell text-center" id="GRAND_TOTAL_AMOUNT">₱0.00</th>
													
													<th class="d-none d-sm-table-cell text-center" id="GRAND_TOTAL_ROLLING">₱0.00</th>
													<th class="d-none d-sm-table-cell text-center" id="GRAND_CHIPS_RETURN">₱0.00</th>
													
													<th class="d-none d-sm-table-cell text-center" id="GRAND_WIN_LOSS">₱0.00</th>
													<th></th>
													<th class="d-none d-sm-table-cell text-center" id="GRAND_NGR">₱0.00</th>
													<th class="d-none d-sm-table-cell text-center" id="GRAND_RTP">₱0.00</th>
													<th class="d-none d-sm-table-cell text-center" id="GRAND_RM">₱0.00</th>
													<th class="d-none d-sm-table-cell text-center" id="GRAND_EXPENSE">₱0.00</th>
													<th class="d-none d-sm-table-cell text-center" id="GRAND_PROFIT">₱0.00</th>													
												</tr>
											</tfoot>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script>
			$(document).ready(function() {
				function initializeDataTable() {
					if ($.fn.DataTable.isDataTable('#guest_game_statistic-tbl')) {
						$('#guest_game_statistic-tbl').DataTable().destroy();
					}
			
					// $('#guest_game_statistic-tbl').DataTable({
					// 	"ajax": {
					// 		"url": "/game_list_data",
					// 		"dataSrc": function (json) {
					// 			console.log("Data received from server:", json);
					// 			return json.data || []; // Default to empty array if no data
					// 		}
					// 	},
					// 	"columns": [
					// 	   
					// 	    { "data": "game_type" },
					// 		
					// 		{ "data": "total_amt" },
					// 		{ "data": "win_loss" },
					// 		{ "data": "total_rolling" },
					// 		
					// 		{ "data": "commission" }
					// 		
					// 	],
					// 	"drawCallback": function() {
					// 		calculateTotal();
					// 	}
					// });
				}
			
				
						initializeDataTable();
		
	
						
				function calculateTotal() {
					var totalAmount = 0;
					var totalRolling = 0;
					var totalChipsReturn = 0;
					var totalWinLoss = 0;
					var totalNgr = 0;
					var totalRtp = 0;
					var totalRm = 0;
					var totalExpense = 0;
					var totalProfit = 0;

					var table = $('#guest_game_statistic-tbl').DataTable();
					table.rows({ search: 'applied' }).every(function() {
						var data = this.data();
						console.log("Processing object:", data);

						// Adjust these indices based on your columns configuration
						var amountIndex = 1; // Assuming "TOTAL AMT" is at index 4
						var rollingIndex = 2; // Assuming "TOTAL ROLLING" is at index 6
						var chipsReturnIndex = 3; // Assuming "CHIPS RETURN" is at index 7
						var winLossIndex = 4; // Assuming "WIN/LOSS" is at index 10
						var ngrIndex = 6;
						var rtpIndex = 7;
						var rmIndex = 8;
						var expenseIndex = 9;
						var profitIndex = 10;

						var amountValue = data[amountIndex] || '0';
						var rollingValue = data[rollingIndex] || '0';
						var chipsReturnValue = data[chipsReturnIndex] || '0';
						var winLossValue = data[winLossIndex] || '0';
						var ngrValue = data[ngrIndex] || '0';
						var rtpValue = data[rtpIndex] || '0';
						var rmValue = data[rmIndex] || '0';
						var expenseValue = data[expenseIndex] || '0';
						var profitValue = data[profitIndex] || '0';


						// Remove HTML tags and clean values
						var cleanedAmountValue = parseFloat(amountValue.replace(/[^0-9.-]/g, '')) || 0;
						var cleanedRollingValue = parseFloat(rollingValue.replace(/[^0-9.-]/g, '')) || 0;
						var cleanedChipsReturnValue = parseFloat(chipsReturnValue.replace(/<[^>]*>/g, '').replace(/[^0-9.-]/g, '')) || 0;
						var cleanedWinLossValue = parseFloat(winLossValue.replace(/[^0-9.-]/g, '')) || 0;
						var cleanedNgrValue = parseFloat(ngrValue.replace(/[^0-9.-]/g, '')) || 0;
						var cleanedRtpValue = parseFloat(rtpValue.replace(/[^0-9.-]/g, '')) || 0;
						var cleanedRmValue = parseFloat(rmValue.replace(/[^0-9.-]/g, '')) || 0;
						var cleanedExpenseValue = parseFloat(expenseValue.replace(/[^0-9.-]/g, '')) || 0;
						var cleanedProfitValue = parseFloat(profitValue.replace(/[^0-9.-]/g, '')) || 0;


						totalAmount += cleanedAmountValue;
						totalRolling += cleanedRollingValue;
						totalChipsReturn += cleanedChipsReturnValue;
						totalWinLoss += cleanedWinLossValue;
						totalNgr += cleanedNgrValue;
						totalRtp += cleanedRtpValue;
						totalRm += cleanedRmValue;
						totalExpense += cleanedExpenseValue;
						totalProfit += cleanedProfitValue;

					});

					// Format the totals
					var formattedAmount = totalAmount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
					var formattedRolling =  totalRolling.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
					var formattedChipsReturn = totalChipsReturn.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
					var formattedWinLoss = totalWinLoss.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
					var formattedNgr = totalNgr.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
					var formattedRtp = totalRtp.toLocaleString();
					var formattedRm = totalRm.toLocaleString();
					var formattedExpense = totalExpense.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
					var formattedProfit = totalProfit.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

					// Update the footer content
					$('#guest_game_statistic-tbl tfoot #GRAND_TOTAL_AMOUNT').text(formattedAmount);
					$('#guest_game_statistic-tbl tfoot #GRAND_TOTAL_ROLLING').text(formattedRolling);
					$('#guest_game_statistic-tbl tfoot #GRAND_CHIPS_RETURN').text(formattedChipsReturn);
					$('#guest_game_statistic-tbl tfoot #GRAND_WIN_LOSS').text(formattedWinLoss);
					$('#guest_game_statistic-tbl tfoot #GRAND_NGR').text(formattedNgr);
					$('#guest_game_statistic-tbl tfoot #GRAND_RTP').text(formattedRtp);
					$('#guest_game_statistic-tbl tfoot #GRAND_RM').text(formattedRm);
					$('#guest_game_statistic-tbl tfoot #GRAND_EXPENSE').text(formattedExpense);
					$('#guest_game_statistic-tbl tfoot #GRAND_PROFIT').text(formattedProfit);

					
				}

				// Attach events to recalculate totals on search and draw
				$('#guest_game_statistic-tbl').on('search.dt draw.dt', function () {
					console.log("Search or draw event triggered");
					calculateTotal();
				});
			});
		</script>

		<%- include ('add_expense') %>
	
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
		<script src="/assets/js/datatables/game_list_tables_datatables.min.js"></script>
		<script src="/assets/js/functions/guest_game_stats.js"></script>
		<script src="assets/js/plugins/select2/js/select2.full.min.js"></script>
		<script src="assets/libs/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>

		
		

		<script>
			// Pass translations to JavaScript
			window.guestGameStatisticTranslations = {
				search: "<%= __('guest_game_statistic.search') %>",
				showing_entries: "<%= __('guest_game_statistic.showing_entries') %>",
				previous: "<%= __('guest_game_statistic.previous') %>",
				next: "<%= __('guest_game_statistic.next') %>"
			};

			$('.js-select2').select2({
				placeholder: 'Select an option',
				dropdownParent: '#modal-new-game-list',
			});
			
		</script>
		
		<style>
		* Base table styles */
 #guest_game_statistic-tbl {
    width: 100%;
    font-size: 13px;
    border-collapse: collapse;
}

/* Header styles */
		#guest_game_statistic-tbl thead th {
    background: var(--bs-primary-bg-subtle);
    color: var(--bs-primary);
    font-weight: 500;
    padding: 12px 15px;
    text-align: left;
    border: none;
}

/* Row styles */
	#guest_game_statistic-tbl tbody tr {
    border-bottom: 1px solid #eee;
}

/* Cell styles */
#guest_game_statistic-tbl td {
    padding: 12px 15px;
    color: #666;
}

#guest_game_statistic-tbl tbody tr:hover {
  background-color: #f5f5f5 !important;
}



/* Balance column */
#guest_game_statistic-tbl td:last-child {
    text-align: center;
    color: #333;
}


/* Footer total row */


#guest_game_statistic-tbl tfoot th {
    padding: 10px;
    font-weight: 600;
  
    color: #333;
    background-color: #f4f6fa;
    border-top: 2px solid #dee2e6;
}
@media (max-width: 768px) {
    #guest_game_statistic-tbl {
        font-size: 10px; /* Mas maliit sa mobile */
    }

    #guest_game_statistic-tbl th,
    #guest_game_statistic-tbl td {
        padding: 5px;
    }
}
							/* Itago ang text na "Show" at "entries" sa DataTables */
							.dataTables_length label {
								font-size: 0; /* Itatago ang text */
							}
							
							/* Panatilihin ang dropdown na nakikita */
							.dataTables_length select {
								font-size: 12px; /* Ibalik ang font size ng dropdown */
							}
							
							
							
								/* Adjust spacing and alignment for date range picker */
							.dataTables_wrapper .row {
								margin-bottom: 15px;
								font-size: 12px; /* Pareho sa commission-tbl */
							}
							
							/* Flexbox layout for the date range picker */
							.input-daterange {
								display: flex;
								justify-content: space-between;
								position: relative;
								left: 7.5rem;
								top: 4rem;
								max-width: 300px;
								font-size: 12px; /* Pareho sa commission-tbl */
							}
							
							/* Styling for form controls */
							.input-daterange .form-control {
								flex: 1;
								margin-right: 5px;
								max-width: 120px;
								font-size: 12px; /* Pareho sa commission-tbl */
								padding: 8px; /* Pareho sa cell padding ng table */
							}
							
							/* Remove margin from the last input */
							.input-daterange .form-control:last-child {
								margin-right: 0;
							}
							
							/* Responsive tweaks */
							@media (max-width: 768px) {
								.dataTables_wrapper .row,
								.input-daterange,
								.input-daterange .form-control {
									font-size: 10px; /* Mas maliit sa mobile */
								}
							
								.input-daterange .form-control {
									padding: 5px; /* Mas maliit na padding */
								}
							}
		</style>


		

<%- include ('../partials/footer') %>

		